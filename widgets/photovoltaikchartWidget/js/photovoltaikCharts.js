var months={en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],de:["Jan","Feb","Mär","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],ru:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],es:["Jan","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],fr:["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],it:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],pl:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],pt:["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Set","Out","Nov","Dez"],nl:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},days={en:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],de:["So","Mo","Di","Mi","Do","Fr","Sa"],ru:["Пн","Вт","Ср","Чт","Пт","Сб","Вс"],es:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],fr:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],it:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],pl:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],pt:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],nl:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]};function readOneChart(i,e,t,n,s,o,r,l,a,d){var c,g={},u=(new Date).getFullYear(),h=new Date(a).getFullYear(),p=u-h+1;g.start=a,g.end=new Date(u,11,31,23,59).getTime(),g.instance=t,g.aggregate="none",g.count=1e3,g.timeout=6e3,console.log(new Date(g.start)+" - "+new Date(g.end)),vis.getHistory(e,g,function(e,t){if(console.log("got History data"),e&&0<Object.keys(e).length&&console.error("Error Object: "+JSON.stringify(e)),!e&&t){for(var a=0;a<t.length;a++)c=new Date(t[a].ts),1===l?i[(c.getFullYear()-h)*d+o].data[c.getMonth()]=(t[a].val||0)*s:i[o].data[p-1-u+c.getFullYear()]=(t[a].val||0)*s;t=null}n&&(1===l?i[(u-h)*d+o].data[(new Date).getMonth()]=(vis.states[n+".val"]||0)*s:i[o].data[p-1]=(vis.states[n+".val"]||0)*s),r&&r()})}function _readData(e,t,a,i,n,s){if((i=i||0)>=t.length)return a&&a();t[i].historyOID&&t[i].instance?readOneChart(e,t[i].historyOID,t[i].instance,t[i].currentOID,t[i].multiplicator,i,function(){setTimeout(function(){_readData(e,t,a,i+1,n,s)},10)},n,s,t.length):setTimeout(function(){_readData(e,t,a,i+1,n,s)},10)}function loadSelectorData(n,e,s,o,r,l,t,d){var a=new Date;a.setMonth(-1*t);var c=a.getTime();e&&s?vis.conn.sendTo(s,"query","select id from iobroker.datapoints where name ='"+e+"'",function(e){if(e.error)console.error(e.error),d&&d();else if(console.log("Rows: "+JSON.stringify(e.result)),e.result[0]&&e.result[0].id){var i=e.result[0].id;vis.conn.sendTo(s,"query","select COUNT(ts) AS rowcount from iobroker.ts_number where id="+i+" and ts>"+c,function(e){if(e.error)console.error(e.error),d&&d();else if(console.log("Rows: "+JSON.stringify(e.result)),e.result[0]&&e.result[0].rowcount){var t=e.result[0].rowcount;if(t<1e3)var a="SELECT ts,val FROM iobroker.ts_number where id="+i;else if(t<1e4)a="SELECT * FROM ( SELECT @row := @row +1 AS rownum, ts,val FROM (SELECT @row :=0) r, iobroker.ts_number where id="+i+" and ts>"+c+") ranked WHERE rownum % ("+t+" DIV 200) = 1";else if(t<5e4)a="SELECT * FROM ( SELECT @row := @row +1 AS rownum, ts,val FROM (SELECT @row :=0) r, iobroker.ts_number where id="+i+" and ts>"+c+") ranked WHERE rownum % ("+t+" DIV 300) = 1";else if(t<8e4)a="SELECT * FROM ( SELECT @row := @row +1 AS rownum, ts,val FROM (SELECT @row :=0) r, iobroker.ts_number where id="+i+" and ts>"+c+") ranked WHERE rownum % ("+t+" DIV 500) = 1";else a="SELECT * FROM ( SELECT @row := @row +1 AS rownum, ts,val FROM (SELECT @row :=0) r, iobroker.ts_number where id="+i+" and ts>"+c+") ranked WHERE rownum % ("+t+" DIV 1000) = 1";vis.conn.sendTo(s,"query",a,function(e){if(e.error)console.error(e.error),d&&d();else{for(var t=0;t<e.result.length;t++)eventDate=normalizeDate(new Date(e.result[t].ts),l),n.push([eventDate.getTime(),(e.result[t].val||0)*r]);res=null,o&&n.push([normalizeDate(new Date,l).getTime(),(vis.states[o+".val"]||0)*r]),d&&d()}})}else d&&d()})}else d&&d()}):d&&d()}function readOneLineRange(i,e,t,n,s,o,r,a,l,d,c,g){var u,h={},p=new Date(0),m=((new Date).getFullYear(),[]);d<a&&m.push([d,0]),h.start=a,h.end=l,h.instance=t,h.aggregate="minmax",h.timeout=6e3,console.log(JSON.stringify(h)),console.log("Load Range for "+e+" "+new Date(h.start)+" - "+new Date(h.end)),vis.getHistory(e,h,function(e,t){if(e&&0<Object.keys(e).length&&console.error("Error Object: "+JSON.stringify(e)),!e&&t){console.log("got History data. Count:"+t.length);for(var a=0;a<t.length;a++)u=normalizeDate(new Date(t[a].ts),r),null!=t[a].val&&(p.getTime()==u.getTime()?m[m.length-1][1]=(t[a].val||0)*s:(m.push([u.getTime(),(t[a].val||0)*s]),p=u));t=null}n&&(console.log("Add current value for "+n+": date "+normalizeDate(new Date,r).getTime()+"value "+vis.states[n+".val"]),0<m.length&&m[m.length-1][0]==normalizeDate(new Date,r).getTime()?m[m.length-1][1]=(vis.states[n+".val"]||0)*s:m.push([normalizeDate(new Date,r).getTime(),(vis.states[n+".val"]||0)*s])),l<c&&m.push([c,0]),i.series[o].setData(m,!1),g&&g()})}function readAndAddOneLineRange(i,e,t,n,s,o,a,r,l,d){var c,g={},u=new Date(0),h=((new Date).getFullYear(),[]);g.start=a,g.end=r,g.instance=t,g.aggregate="minmax",g.timeout=6e3,console.log("Load Range for "+e+" "+new Date(g.start)+" - "+new Date(g.end)),vis.getHistory(e,g,function(e,t){if(e&&0<Object.keys(e).length&&console.error("Error Object: "+JSON.stringify(e)),!e&&t){console.log("got History data. Count:"+t.length);for(var a=0;a<t.length;a++)c=normalizeDate(new Date(t[a].ts),o),null!=t[a].val&&(u.getTime()==c.getTime()?h[h.length-1][1]=(t[a].val||0)*n:(h.push([c.getTime(),(t[a].val||0)*n]),u=c));t=null,0<h.length&&l<h[h.length-1][0]&&(l=h[h.length-1][0]);for(a=0;a<h.length;a++)i.series[s].addPoint(h[a],!1,!1,!1,!1)}d&&d(l)})}function loadSeriesRange(e,t,a,i,n,s,o,r,l){if((a=a||0)>=t.length)return l&&l();t[a].historyOID&&t[a].instance?readOneLineRange(e,t[a].historyOID,t[a].instance,t[a].currentOID,t[a].multiplicator,a,i,n,s,o,r,function(){setTimeout(function(){loadSeriesRange(e,t,a+1,i,n,s,o,r,l)},10)}):setTimeout(function(){loadSeriesRange(e,t,a+1,i,n,s,o,r,l)},10)}function loadAndAddSeriesRange(t,a,i,n,s,o,e,r){if((i=i||0)>=a.length)return r&&r(e);a[i].historyOID&&a[i].instance?readAndAddOneLineRange(t,a[i].historyOID,a[i].instance,a[i].multiplicator,i,n,s,o,e,function(e){setTimeout(function(){loadAndAddSeriesRange(t,a,i+1,n,s,o,e,r)},10)}):setTimeout(function(){loadAndAddSeriesRange(t,a,i+1,n,s,o,e,r)},10)}function normalizeDate(e,t){if("hour"==t)e.setMilliseconds(0),e.setSeconds(0),e.setMinutes(0);else if("day"==t)e.setUTCMilliseconds(0),e.setUTCSeconds(0),e.setUTCMinutes(0),e.setUTCHours(0);else{if("week"==t){var a=e.getDay(),i=e.getDate()-a+(0==a?-6:1);return(e=new Date(e.setDate(i))).setUTCMilliseconds(0),e.setUTCSeconds(0),e.setUTCMinutes(0),e.setUTCHours(0),e}"month"==t?(e.setUTCMilliseconds(0),e.setUTCSeconds(0),e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCDate(1)):"year"==t&&(e.setUTCMilliseconds(0),e.setUTCSeconds(0),e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCDate(1),e.setUTCMonth(0))}return e}var minDate=new Date(2020,0,1).getTime();!function(u){u.Chart.prototype.pan=function(f,e){var t,y,a,w=this,i=w.hoverPoints,n=w.options.chart;t="object"==typeof e?e:{enabled:e,type:"x"},n&&n.panning&&(n.panning=t),a=t.type,u.fireEvent(this,"pan",{originalEvent:f},function(){i&&i.forEach(function(e){e.setState()});var e=[1];"xy"===a?e=[1,0]:"y"===a&&(e=[0]),e.forEach(function(e){var t,a=w[e?"xAxis":"yAxis"][0],i=a.options,n=a.horiz,s=f[n?"chartX":"chartY"],o=n?"mouseDownX":"mouseDownY",r=w[o],l=(a.pointRange||0)/2,d=a.reversed&&!w.inverted||!a.reversed&&w.inverted?-1:1,c=a.getExtremes(),g=a.toValue(r-s,!0)+l*d,u=a.toValue(r+a.len-s,!0)-l*d,h=u<g,p=h?u:g,m=h?g:u,v=minDate,x=(new Date).getTime();i.ordinal||(e&&(0<(t=v-p)&&(m+=t,p=v),0<(t=m-x)&&(m=x,p-=t)),(a.series.length&&p!==c.min&&m!==c.max&&e||a.panningState&&p>=a.panningState.startMin&&m<=a.panningState.startMax)&&(a.setExtremes(p,m,!1,!1,{trigger:"pan"}),y=!0),w[o]=s)}),y&&w.redraw(!1),u.css(w.container,{cursor:"move"})})},u.Chart.prototype.zoom=function(e){console.log("Chart Zoom handler ");var o,r=this,l=r.pointer,d=r.inverted?l.mouseDownX:l.mouseDownY,c=!1;!e||e.resetSelection?(r.axes.forEach(function(e){o=e.zoom()}),l.initiated=!1):e.xAxis.concat(e.yAxis).forEach(function(e){var t=e.axis,a=r.inverted?t.left:t.top,i=r.inverted?a+t.width:a+t.height,n=t.isXAxis,s=!1;(!n&&a<=d&&d<=i||n||!u.defined(d))&&(s=!0),l[n?"zoomX":"zoomY"]&&s&&(o=t.zoom(e.min,e.max),t.displayBtn&&(c=!0))});var t=r.resetZoomButton;c&&!t?r.showResetZoom():!c&&u.isObject(t)&&(r.resetZoomButton=t.destroy()),o&&r.redraw(u.pick(r.options.chart.animation,e&&e.animation,r.pointCount<100))},u.Axis.prototype.zoom=function(e,t){console.log("Axis Zoom handler min:"+new Date(e)+" max:"+new Date(t));var a,i,n=this;(n=this.chart)&&n.navigator&&n.navigator.xAxis&&(i=n.navigator.xAxis.min,a=n.navigator.xAxis.max);var s=this,o=this.dataMin,r=this.dataMax,l=this.options,d=Math.min(o,u.pick(l.min,o),i),c=Math.max(r,u.pick(l.max,r),a),g={newMin:e,newMax:t};return u.fireEvent(this,"zoom",g,function(e){var t=e.newMin,a=e.newMax;t===s.min&&a===s.max||(s.allowZoomOutside||(u.defined(o)&&(t<d&&(t=d),c<t&&(t=c)),u.defined(r)&&(a<d&&(a=d),c<a&&(a=c))),s.displayBtn=!1,s.setExtremes(t,a,!1,void 0,{trigger:"zoom"})),e.zoomed=!0}),g.zoomed},u.Pointer.prototype.pinch=function(e){console.log("Pointer pinch handler ");var t=this,r=t.chart,a=t.pinchDown,i=e.touches||[],n=i.length,s=t.lastValidTouch,o=t.hasZoom,l={},d=1===n&&(t.inClass(e.target,"highcharts-tracker")&&r.runTrackerClick||t.runChartClick),c={},g=t.selectionMarker;1<n?t.initiated=!0:1===n&&this.followTouchMove&&(t.initiated=!1),o&&t.initiated&&!d&&!1!==e.cancelable&&e.preventDefault(),[].map.call(i,function(e){return t.normalize(e)}),"touchstart"===e.type?([].forEach.call(i,function(e,t){a[t]={chartX:e.chartX,chartY:e.chartY}}),s.x=[a[0].chartX,a[1]&&a[1].chartX],s.y=[a[0].chartY,a[1]&&a[1].chartY],r.axes.forEach(function(e){if(e.zoomEnabled){var t=r.bounds[e.horiz?"h":"v"],a=e.minPixelPadding,i=e.toPixels(Math.min(u.pick(e.options.min,e.dataMin),e.dataMin,minDate)),n=e.toPixels(Math.max(u.pick(e.options.max,e.dataMax),e.dataMax,(new Date).getTime())),s=Math.min(i,n),o=Math.max(i,n);t.min=Math.min(e.pos,s-a),t.max=Math.max(e.pos+e.len,o+a)}}),t.res=!0):t.followTouchMove&&1===n?this.runPointActions(t.normalize(e)):a.length&&(u.fireEvent(r,"touchpan",{originalEvent:e},function(){g||(t.selectionMarker=g=extend({destroy:u.noop,touch:!0},r.plotBox)),t.pinchTranslate(a,i,l,g,c,s),t.hasPinched=o,t.scaleGroups(l,c)}),t.res&&(t.res=!1,this.reset(!1,0)))}}(Highcharts);var types=["DOMMouseScroll","mousewheel"];function handler(e){var t=e||window.event,a=[].slice.call(arguments,1),i=0,n=0,s=0;return(e=$.event.fix(t)).type="mousewheel",e.wheelDelta&&(i=e.wheelDelta/120),e.detail&&(i=-e.detail/3),s=i,void 0!==t.axis&&t.axis===t.HORIZONTAL_AXIS&&(s=0,n=-1*i),void 0!==t.wheelDeltaY&&(s=t.wheelDeltaY/120),void 0!==t.wheelDeltaX&&(n=-1*t.wheelDeltaX/120),a.unshift(e,i,n,s),$.event.handle.apply(this,a)}$.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var e=types.length;e;)this.addEventListener(types[--e],handler,!1);else this.onmousewheel=handler},teardown:function(){if(this.removeEventListener)for(var e=types.length;e;)this.removeEventListener(types[--e],handler,!1);else this.onmousewheel=null}},$.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}}),vis.binds.photovoltaikcharts={version:"1.0.9",updateIntervalHandler:[],reloadIntervalHandler:[],delayedRefreshHandler:[],playHandler:[],showVersion:function(){vis.binds.photovoltaikcharts.version&&(console.log("Version vis-photovoltaikcharts: "+vis.binds.photovoltaikcharts.version),vis.binds.photovoltaikcharts.version=null)},highchartsOptions:{lang:{months:["Januar","Februar","März","April","Mai","Juni","Juli","August","September","Oktober","November","Dezember"],weekdays:["Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],shortWeekdays:["So","Mo","Di","Mi","Do","Fr","Sa"],shortMonths:["Jan","Feb","Mrz","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"],contextButtonTitle:"Kontextmenü",decimalPoint:",",downloadCSV:"CSV-Datei herunterladen",downloadJPEG:"JPG-Datei herunterladen",downloadPDF:"PDF-Datei herunterladen",downloadPNG:"PNG-Datei herunterladen",downloadSVG:"SVG-Datei herunterladen",downloadXLS:"XLS-Datei herunterladen",exitFullscreen:"Vollbildanzeige beenden",hideData:"Datentabellen ausblenden",loading:"Laden...",noData:"Keine Daten",numericSymbols:["k","M","G","T","P","E"],printChart:"Diagramm drucken",resetZoom:"Zoom zurücksetzen",resetZoomTitle:"Zoom auf 1:1 zurücksetzen",viewData:"Datentabelle anzeigen",viewFullscreen:"Als Vollbild anzeigen",exportData:{annotationHeader:"Anmerkungen",categoryDatetimeHeader:"Datum/Zeit",categoryHeader:"Kategorie"}}},highchartsSeriesUnits:[["second",[1]],["minute",[1]],["hour",[1]],["day",[1]],["week",[1]],["month",[1,3,6]],["year",null]],highchartsDateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%e. %b",week:"%e. %b",month:"%b '%y",year:"%Y"},scrollspeed:.3,getUniqueOID:function(e){var t=[];return e.forEach(function(e){t.indexOf(e.currentOID)<0&&t.push(e.currentOID)}),t},findOID:function(e,t){for(var a=[],i=0;i<e.length;i++)e[i].currentOID+".val"==t&&a.push(i);return a},createMonthlyWidget:function(t,e,a,i){var n=[],s=[],o=null,r=null,l=this;console.log(" vis-photovoltaikcharts: Create Monthly Widget");var d=$("#"+t);if(!d.length)return setTimeout(function(){l.createMonthlyWidget(t,e,a,i)},100);console.log("Initialize Chart Widget #"+t);var c="en";"undefined"!=typeof sysLang&&(c=sysLang||"en"),a.target&&(o=a.target.split(",")),s=[],n=[];var g,u=0;for(g=1;g<=a.seriesCount;g++)a["serieshistoryoid"+g]&&a["instance"+g]&&(s.push({id:u,historyOID:a["serieshistoryoid"+g],instance:a["instance"+g],currentOID:a["seriescurrentoid"+g],multiplicator:parseFloat(a["multiplicator"+g])||1,lastX:0}),u++);var h=new Date,p=a.numberOfYears||3,m=h.getFullYear(),v=[[0,0,0],[.8,0,0],[1.7,0,0],[2.6,0,0],[3.5,0,0],[4.7,0,0],[5.7,0,0],[6.7,0,0],[7.6,0,0],[8.6,0,0],[9.5,0,0],[10.4,0,0],[11.4,0,0]],x=[m.toString(),(m-1).toString(),(m-2).toString()];x=[];n=[];for(var f=0;f<p;f++)for(x.push(m-f),g=1;g<=a.seriesCount;g++)a["serieshistoryoid"+g]&&a["instance"+g]&&n.push({name:(a["serieslabel"+g]||"")+" "+(m-p+f+1).toString().substr(-2),data:[0,0,0,0,0,0,0,0,0,0,0,0],stack:p-f-1,color:a["yearcolor"+g+(p-f)]||void 0,lineWidth:a["serieslinewidth"+g]||1,fillOpacity:a["seriesopacity"+g]?parseFloat(a["seriesopacity"+g])/100:.3,type:a["seriesType"+g]||"column",opacity:.9});if(Array.isArray(o)){for(var y=0;y<o.length;y++)v[y][1]=parseFloat(o[y]);n.push({type:"scatter",lineWidth:2,name:a.targetName||"Target",step:"left",data:v,color:"#A4A4A4",marker:{enabled:!1}})}function w(e,t,a){if(r&&t!=a)for(var i=l.findOID(s,e.type),n=0;n<i.length;n++)r.series[(p-1)*s.length+i[n]].data[(new Date).getMonth()].update((parseFloat(t)||0)*s[i[n]].multiplicator)}"de"===vis.language&&Highcharts.setOptions(l.highchartsOptions),_readData(n,s,function(){var e=a.unit;r=Highcharts.chart("chart_placeholder"+t,{chart:{width:d.width()-2,height:d.height()-2,zoomType:"x",type:"column",options3d:{enabled:!0,alpha:a.alpha||8,beta:a.beta||8,depth:a.depth||200,viewDistance:a.viewDistance||5,frame:{bottom:{size:1,color:"rgba(0,0,0,0.05)"}}}},title:{text:a.title},xAxis:{categories:months[c]},yAxis:{title:{text:e}},zAxis:{min:0,max:2,labels:{y:5,rotation:18},categories:x},plotOptions:{column:{stacking:"normal"},series:{groupZPadding:10,depth:50,groupPadding:.05,grouping:!1}},legend:{enabled:a.showLegend},exporting:{enabled:a.showMenu},tooltip:{formatter:function(){return this.point.stackTotal?"<b>"+this.x+" "+this.series.chart.zAxis[0].options.categories[this.series.userOptions.stack]+"</b><br/>"+this.series.name+": "+this.y+"<br/>"+(a.stacklabel||"Erzeugung:")+" "+this.point.stackTotal+(Array.isArray(o)?"<br/>"+(a.targetName||"Target")+": "+o[this.point.x]:""):"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y}},series:n,credits:{enabled:!1}})},0,1,new Date(m-p+1,0,1).getTime());var D=l.getUniqueOID(s);for(f=0;f<D.length;f++)D[f]&&(console.log("register on changes for "+D[f]),vis.states.bind(D[f]+".val",w),d.data("bound",[D[f]+".val"]),d.data("bindHandler",w))},createYearlyWidget:function(t,e,s,a){var i=[],o=[],r=null,l=this;console.log(" vis-photovoltaikcharts: Create Yearly Widget");var n=$("#"+t);if(!n.length)return setTimeout(function(){l.createYearlyWidget(t,e,s,a)},100);console.log("Initialize Chart Widget #"+t);"undefined"!=typeof sysLang&&sysLang;for(var d=s.numberOfYears||4,c=(new Date).getFullYear(),g=[],u=[],h=d-1;0<=h;h--)g.push(c-h),u.push(0);o=[],i=[];var p=0;for(h=1;h<=s.seriesCount;h++)s["serieshistoryoid"+h]&&s["instance"+h]&&(o.push({id:p,historyOID:s["serieshistoryoid"+h],instance:s["instance"+h],currentOID:s["seriescurrentoid"+h],multiplicator:parseFloat(s["multiplicator"+h])||1,lastX:0}),i.push({name:s["serieslabel"+h],data:u.slice(0),color:s["seriescolor"+h]||void 0,lineWidth:s["serieslinewidth"+h]||1,fillOpacity:s["seriesopacity"+h]?parseFloat(s["seriesopacity"+h])/100:.3,type:s["seriesType"+h]||"column",opacity:.9}),p++);var m=[];function v(e,t,a){if(r&&t!=a)for(var i=l.findOID(o,e.type),n=(normalizeDate(new Date,s.normalizeDate),0);n<i.length;n++)r.series[i[n]].data[d-1].update((parseFloat(t)||0)*o[i[n]].multiplicator)}s.target&&m.push({color:"#33FF50",dashStyle:"Solid",label:s.targetName||"Target",value:parseFloat(s.target),width:2}),_readData(i,o,function(){"de"===vis.language&&Highcharts.setOptions(l.highchartsOptions);var e=s.unit;r=Highcharts.chart("chart_placeholder"+t,{chart:{width:n.width()-2,height:n.height()-2,zoomType:"x",type:"column",options3d:{enabled:!0,alpha:s.alpha||8,beta:s.beta||8,depth:s.depth||50,viewDistance:s.viewDistance||5,frame:{bottom:{size:1,color:"rgba(0,0,0,0.05)"}}}},title:{text:s.title},xAxis:{categories:g},yAxis:{title:{text:e},plotLines:m},series:{groupZPadding:10,depth:50,groupPadding:.05,grouping:!1},legend:{enabled:s.showLegend},exporting:{enabled:s.showMenu},tooltip:{formatter:function(){return this.point.stackTotal?"<b>"+this.x+" "+this.series.chart.zAxis[0].options.categories[this.series.userOptions.stack]+"</b><br/>"+this.series.name+": "+this.y+"<br/>"+(s.stacklabel||"Erzeugung:")+" "+this.point.stackTotal+(Array.isArray(null)?"<br/>"+(s.targetName||"Target")+": "+null[this.point.x]:""):"<b>"+this.x+"</b><br/>"+this.series.name+": "+this.y}},series:i,credits:{enabled:!1}})},0,2,new Date(c-d+1,0,1).getTime());var x=l.getUniqueOID(o);for(h=0;h<x.length;h++)x[h]&&(console.log("register on changes for "+x[h]),vis.states.bind(x[h]+".val",v),n.data("bound",[x[h]+".val"]),n.data("bindHandler",v))},createTimeseriesWidget:function(t,e,d,a){var i=[],c=[],s="chart_placeholder",g=null,u=this,o=!1,n=!1,r=null,l=[];console.log(" photovoltaikcharts: Create Timeseries Widget");var h=$("#"+t);if(!h.length)return setTimeout(function(){u.createTimeseriesWidget(t,e,d,a)},100);console.log("Initialize Chart Widget #"+t);"undefined"!=typeof sysLang&&sysLang,c=[],i=[];var p=0;for(w=1;w<=d.seriesCount;w++)d["serieshistoryoid"+w]&&d["instance"+w]&&(c.push({id:p,historyOID:d["serieshistoryoid"+w],instance:d["instance"+w],currentOID:d["seriescurrentoid"+w],multiplicator:parseFloat(d["multiplicator"+w])||1,lastX:0}),i.push({name:d["serieslabel"+w],boostThreshold:1,data:[],color:d["seriescolor"+w]||"#FF5A33",lineWidth:d["serieslinewidth"+w]||1,fillOpacity:d["seriesopacity"+w]?parseFloat(d["seriesopacity"+w])/100:.3,type:d["seriesType"+w]||"areaspline",yAxis:d["seriesaxis"+w]?parseInt(d["seriesaxis"+w]):0,step:d["seriesstep"+w]&&"no"!=d["seriesstep"+w]?d["seriesstep"+w]:void 0,stacking:d["seriesstacking"+w]&&"no"!=d["seriesstacking"+w]?d["seriesstacking"+w]:void 0,dataGrouping:{enabled:d["seriesgrouping"+w],approximation:"high",units:"column"!=d["seriesType"+w]?u.highchartsSeriesUnits:void 0},states:{hover:{enabled:!0,lineWidth:d["serieshoverlinewidth"+w]||1}},pointInterval:1e4}),p++);var m=[];function v(e,t,a){if(console.log("resize chart to "+new Date(e)+" - "+new Date(t)),!1,e&&t){o=!0;var i=e,n=t;g.showLoading(),window.setTimeout(function(){loadSeriesRange(g,c,0,d.normalizeDate,e,t,i,n,function(){g.redraw(),g.hideLoading(),o=!1,a&&a()})},10)}}d.target&&m.push({color:"#33FF50",dashStyle:"Solid",label:d.targetName||"Target",value:parseFloat(d.target),width:2}),u.delayedRefreshHandler[t]&&window.clearInterval(u.delayedRefreshHandler[t]),u.delayedRefreshHandler[t]=window.setInterval(function(){0==o&&1==n&&(n=!1,console.log("Process event "+new Date(r.min)+" - "+new Date(r.max)),v(r.min,r.max))},500),"de"===vis.language&&Highcharts.setOptions(u.highchartsOptions);var x=d.unit;function f(e,t,a){if(g&&t!=a)for(var i=u.findOID(c,e.type),n=normalizeDate(new Date,d.normalizeDate),s=0;s<i.length;s++)if(0==i[s]){if(g.navigator.series[0].points&&0<g.navigator.series[0].points.length&&g.navigator.series[0].points[g.navigator.series[0].points.length-1]&&console.log("Last old x:"+g.navigator.series[0].points[g.navigator.series[0].points.length-1].x),g.navigator.series[0].points&&0<g.navigator.series[0].points.length&&g.navigator.series[0].points[g.navigator.series[0].points.length-1]&&g.navigator.series[0].points[g.navigator.series[0].points.length-1].x==n.getTime()?g.navigator.series[0].points[g.navigator.series[0].points.length-1].update((parseFloat(t)||0)*c[i[s]].multiplicator,!1,!1):g.navigator.series[0].addPoint([n.getTime(),(parseFloat(t)||0)*c[i[s]].multiplicator]),g.series[i[s]].points&&g.series[i[s]].points[g.series[i[s]].points.length-1]&&g.series[i[s]].points[g.series[i[s]].points.length-1].x==n.getTime()&&"function"==typeof g.series[i[s]].points[g.series[i[s]].points.length-1].update)console.log("V1 Update series "+(i[s]+1)),g.series[i[s]].points[g.series[i[s]].points.length-1].update((parseFloat(t)||0)*c[i[s]].multiplicator,!1,!1);else if(console.log("Add new value to series 1"),g&&g.xAxis&&void 0!==g.xAxis[0]){var o=g.xAxis[0].getExtremes();console.log("Old extremes: "+JSON.stringify(o));var r=g.navigator.xAxis.max;if(console.log("Last X: "+new Date(r)),console.log("CompareX: "+JSON.stringify(o)),console.log("oldExtremes max: "+new Date(o.max)),o.max>r-6e5){g.series[i[s]].addPoint([n.getTime(),(parseFloat(t)||0)*c[i[s]].multiplicator]);var l=g.navigator.xAxis.max;r!=l&&g.xAxis[0].setExtremes(o.min+l-o.max,l)}}}else if(g.series[i[s]].points&&g.series[i[s]].points[g.series[i[s]].points.length-1]&&g.series[i[s]].points[g.series[i[s]].points.length-1].x==n.getTime()&&"function"==typeof g.series[i[s]].points[g.series[i[s]].points.length-1].update)g.series[i[s]].points[g.series[i[s]].points.length-1].update((parseFloat(t)||0)*c[i[s]].multiplicator,!1,!1);else if(g&&g.xAxis&&void 0!==g.xAxis[1]){o=g.xAxis[1].getExtremes(),r=g.series&&g.series[i[s]].points&&0<g.series[i[s]].points.length&&g.series[i[s]].points[g.series[i[s]].points.length-1]&&g.series[i[s]].points[g.series[i[s]].points.length-1].x?g.series[i[s]].points[g.series[i[s]].points.length-1].x:0;o.max>r-6e5&&g.series[i[s]].addPoint([n.getTime(),(parseFloat(t)||0)*c[i[s]].multiplicator])}}g=Highcharts.stockChart(s+t,{chart:{width:h.width()-2,height:h.height()-2,zoomType:"x",renderTo:s+t,panning:!0,panKey:"shift"},title:{text:d.title},time:{timezoneOffset:"no"==d.normalizeDate||"hour"==d.normalizeDate?(new Date).getTimezoneOffset():0},rangeSelector:{buttons:[{type:"day",count:1,text:"1 Tag",title:"1 Tag anzeigen"},{type:"day",count:3,text:"3 Tage",title:"3 Tage anzeigen"},{type:"day",count:7,text:"7 Tage",title:"7 Tage anzeigen"},{type:"month",count:1,text:"1M",title:"1 Monat anzeigen"},{type:"month",count:3,text:"3M",title:"3 Monate anzeigen"},{type:"month",count:6,text:"6M",title:"6 Monate anzeigen"},{type:"ytd",text:"Aktuelles Jahr",title:"Aktuelles Jahr anzeigen"},{type:"year",count:1,text:"1 Jahr",title:"1 Jahr anzeigen"},{type:"all",text:"Alles",title:"Alles anzeigen"}],allButtonsEnabled:!0,dropdown:"always",height:10,selected:{"1d":0,"3d":1,"7d":2,"1m":3,"3m":4,"6m":5,ytd:6,"1y":7,all:8}[d.zoomDefault],inputDateFormat:"%e. %b %Y"},navigator:{adaptToUpdatedData:!1,height:20,margin:10,series:[{data:null,lineColor:d.navcolor,dataGrouping:{enabled:!0,approximation:"high",units:u.highchartsSeriesUnits},pointInterval:1e4}],xAxis:{ordinal:!1}},scrollbar:{enabled:!1},xAxis:{events:{afterSetExtremes:function(e){console.log("afterSetExtremes event "+new Date(e.min)+" - "+new Date(e.max)+" - "+e.trigger),null!=e.trigger&&(o?(r=e,console.log("Save event "+new Date(e.min)+" - "+new Date(e.max)),n=!0):v(e.min,e.max))},setExtremes:function(e){console.log("setExtremes event "+new Date(e.min)+" - "+new Date(e.max)+" - "+e.trigger)}},dateTimeLabelFormats:u.highchartsDateTimeLabelFormats,overscroll:1e4,ordinal:!1},yAxis:[{labels:{formatter:function(){return this.value+(x?" "+x:"")},align:"left"},title:{text:"Produktion"},height:d.chart1Height?d.chart1Height+"%":"48%",lineWidth:2,resize:{enabled:!0},plotLines:m,min:d.yAxis1min?parseFloat(d.yAxis1min):void 0,max:d.yAxis1max?parseFloat(d.yAxis1max):void 0,tickAmount:d.yAxis1tickamount?d.yAxis1tickamount:void 0,minorTicks:!0},{labels:{formatter:function(){return this.value+" "+x},align:"left"},title:{text:"Verbrauch"},top:d.chart1Height?parseFloat(d.chart1Height)+(d.chartspacing?parseFloat(d.chartspacing):4)+"%":48+(d.chartspacing?parseFloat(d.chartspacing):5)+"%",height:d.chart2Height?d.chart2Height+"%":"48%",offset:0,lineWidth:2,min:d.yAxis2min?parseFloat(d.yAxis2min):void 0,max:d.yAxis2max?parseFloat(d.yAxis2max):void 0,tickAmount:d.yAxis2tickamount?d.yAxis2tickamount:void 0,minorTicks:!0}],plotOptions:{},legend:{enabled:d.showLegend,align:"left",verticalAlign:"top",x:0,y:20,floating:!0,itemStyle:d.legendItemStyle?JSON.parse(d.legendItemStyle):{color:"#333333",cursor:"pointer",fontSize:"12px",fontWeight:"bold",textOverflow:"ellipsis"},itemDistance:d.legendItemDistance?parseInt(d.legendItemDistance):void 0},exporting:{enabled:d.showMenu},credits:{enabled:!1},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>',valueDecimals:2,split:!0,followTouchMove:!1,dateTimeLabelFormats:u.highchartsDateTimeLabelFormats},series:i}),window.setTimeout(function(){loadSelectorData(l,c[0].historyOID,c[0].instance,c[0].currentOID,c[0].multiplicator,d.normalizeDate,d.navigatorRange?parseInt(d.navigatorRange):48,function(){g.navigator.series[0].setData(l),g.navigator.series[0].xAxis.min=l[0][0],d.navcolor&&(g.navigator.series[0].color=d.navcolor);var e=new Date;e.setUTCMilliseconds(0),e.setUTCSeconds(0),"1d"==d.zoomDefault?e.setDate(e.getDate()-1):"7d"==d.zoomDefault?e.setDate(e.getDate()-7):"3d"==d.zoomDefault?e.setDate(e.getDate()-3):"1m"==d.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-1)):"3m"==d.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-3)):"6m"==d.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-6)):"ytd"==d.zoomDefault?e=new Date(e.getFullYear(),0,1):"1y"==d.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-12)):"all"==d.zoomDefault&&(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-120)),v(e.getTime(),(new Date).getTime());var n=0;$("#"+s+t).mousewheel(function(e,t){0<t?(n=-1*u.scrollspeed,a()):t<0&&(n=u.scrollspeed,a())});var a=function(){var e=g.xAxis[0].getExtremes().dataMin,t=g.xAxis[0].getExtremes().dataMax,a=minDate,i=(new Date).getTime();g.xAxis[0].setExtremes(Math.max(a,e-n*(t-e)),Math.min(i,t+n*(t-e)),!0,!0,{trigger:"zoom"})}})},10);for(var y=u.getUniqueOID(c),w=0;w<y.length;w++)y[w]&&(console.log("register on changes for "+y[w]),vis.states.bind(y[w]+".val",f),h.data("bound",[y[w]+".val"]),h.data("bindHandler",f))},createTimeseries2Widget:function(c,e,s,t){var a=[],o=[],i="chart_placeholder",g=null,u=this,r=!1,n=!1,l=null,d=[];console.log(" photovoltaikcharts: Create Timeseries2 Widget");var h=$("#"+c);if(!h.length)return setTimeout(function(){u.createTimeseries2Widget(c,e,s,t)},100);console.log("Initialize Chart Widget #"+c);"undefined"!=typeof sysLang&&sysLang;var p={id:0,historyOID:s.navhistoryoid,instance:s.navinstance,multiplicator:parseFloat(s.navmultiplicator)||1};o=[],a=[];var m,v=0;for(m=1;m<=s.seriesCount;m++)s["serieshistoryoid"+m]&&s["instance"+m]&&(o.push({id:v,historyOID:s["serieshistoryoid"+m],instance:s["instance"+m],multiplicator:parseFloat(s["multiplicator"+m])||1,lastX:0}),a.push({name:s["serieslabel"+m],boostThreshold:1,data:[],color:s["seriescolor"+m]||"#FF5A33",lineWidth:s["serieslinewidth"+m]||1,fillOpacity:s["seriesopacity"+m]?parseFloat(s["seriesopacity"+m])/100:.3,type:s["seriesType"+m]||"areaspline",yAxis:s["seriesaxis"+m]?parseInt(s["seriesaxis"+m]):0,step:s["seriesstep"+m]&&"no"!=s["seriesstep"+m]?s["seriesstep"+m]:void 0,stacking:s["seriesstacking"+m]&&"no"!=s["seriesstacking"+m]?s["seriesstacking"+m]:void 0,dataGrouping:{enabled:s["seriesgrouping"+m],approximation:"high",units:"column"!=s["seriesType"+m]?u.highchartsSeriesUnits:void 0},states:{hover:{enabled:!0,lineWidth:s["serieshoverlinewidth"+m]||1}},pointInterval:1e4}),v++);var x=[];function f(e,t,a){if(console.log("resize chart to "+new Date(e)+" - "+new Date(t)),!1,e&&t){r=!0;var i=e,n=t;console.log("virtual chart size "+new Date(i)+" - "+new Date(n)),g.showLoading(),window.setTimeout(function(){loadSeriesRange(g,o,0,s.normalizeDate,e,t,i,n,function(){g.redraw(),g.hideLoading(),r=!1,a&&a()})},10)}}s.target&&x.push({color:"#33FF50",dashStyle:"Solid",label:s.targetName||"Target",value:parseFloat(s.target),width:2}),u.delayedRefreshHandler[c]&&window.clearInterval(u.delayedRefreshHandler[c]),u.delayedRefreshHandler[c]=window.setInterval(function(){0==r&&1==n&&(n=!1,console.log("Process event "+new Date(l.min)+" - "+new Date(l.max)),f(l.min,l.max))},500),"de"===vis.language&&Highcharts.setOptions(u.highchartsOptions);var y=[{labels:{formatter:function(){return this.value+(s.unit1?" "+s.unit1:"")},align:"left",x:1},title:{text:s.xAxisLabel1},height:s.chart1Height?s.chart1Height+"%":"20%",lineWidth:1,resize:{enabled:!0},categories:s.yAxis1Categories?JSON.parse(s.yAxis1Categories):void 0,offset:0,min:s.yAxis1min?parseFloat(s.yAxis1min):void 0,max:s.yAxis1max?parseFloat(s.yAxis1max):void 0,tickAmount:s.yAxis1tickamount?s.yAxis1tickamount:void 0,minorTicks:!0,startOnTick:!1}];function w(){if(console.log("Start update chart"),g){var t,i,e,n,s,o,r,a,l=g.xAxis[0].getExtremes(),d=g.navigator.xAxis.max;t=g.navigator.series[0].points&&0<g.navigator.series[0].points.length?g.navigator.series[0].points[g.navigator.series[0].points.length-1].x:g.navigator.xAxis.max,console.log("V2 Start UpdateSelector Axis max: "+new Date(d)+" - Data Max: "+new Date(t)),i=p.historyOID,e=p.instance,n=p.multiplicator,s=function(){if(console.log("V2 test extremes of Selector oldExtremes max: "+new Date(l.max)+" oldmax: "+new Date(t)),0<g.navigator.series[0].points.length&&g.navigator.series[0].points[g.navigator.series[0].points.length-1].x>d&&l.max>t-6e5){var e=g.navigator.series[0].points[g.navigator.series[0].points.length-1].x;console.log("V2 set extremes of Selector to "+new Date(l.min+e-l.max)+" "+new Date(e)),g.xAxis[0].setExtremes(l.min+e-l.max,e,!0,!0,{trigger:"zoom"})}},(a={}).start=t+1,a.instance=e,a.aggregate="minmax",a.limit=300,a.timeout=6e3,vis.getHistory(i,a,function(e,t){if(e&&0<Object.keys(e).length&&console.error("Error Object: "+JSON.stringify(e)),!e&&t){console.log("got History data. Count:"+t.length);for(var a=0;a<t.length;a++)o=new Date(t[a].ts),r=t[a].val*n,console.log(i+" "+new Date(t[a].ts)+" n "+o+":"+t[a].val),null!=t[a].val&&(g.navigator.series[0].data&&0<g.navigator.series[0].data.length&&g.navigator.series[0].data[g.navigator.series[0].data.length-1]&&g.navigator.series[0].data[g.navigator.series[0].data.length-1].x==o.getTime()?g.navigator.series[0].data[g.navigator.series[0].data.length-1]&&g.navigator.series[0].data[g.navigator.series[0].data.length-1].y!=r&&g.navigator.series[0].data[g.navigator.series[0].data.length-1].update(r,!1,!1):g.navigator.series[0].addPoint([o.getTime(),r],!1,!1,!1,!1));t=null,g.redraw(!1)}console.log("Finished Selector update"),s&&(console.log("Start callback"),s())})}else u.updateIntervalHandler[c]&&(window.clearInterval(u.updateIntervalHandler[c]),u.updateIntervalHandler[c]=null)}0!=s.chart2enabled&&y.push({labels:{formatter:function(){return this.value+(s.unit2?" "+s.unit2:"")},align:"left",x:1},title:{text:s.xAxisLabel2},top:s.chart1Height?parseFloat(s.chart1Height)+(s.chartspacing?parseFloat(s.chartspacing):5)+"%":20+(s.chartspacing?parseFloat(s.chartspacing):5)+"%",height:s.chart2Height?s.chart2Height+"%":"40%",lineWidth:2,resize:{enabled:!0},categories:s.yAxis2Categories?JSON.parse(s.yAxis2Categories):void 0,offset:0,plotLines:x,min:s.yAxis2min?parseFloat(s.yAxis2min):void 0,max:s.yAxis2max?parseFloat(s.yAxis2max):void 0,tickAmount:s.yAxis2tickamount?s.yAxis2tickamount:void 0,minorTicks:!0}),0!=s.chart3enabled&&y.push({labels:{formatter:function(){return this.value+(s.unit3?" "+s.unit3:"")},align:"left",x:1},title:{text:s.xAxisLabel3},categories:s.yAxis3Categories?JSON.parse(s.yAxis3Categories):void 0,top:(s.chart1Height?parseFloat(s.chart1Height)+(s.chartspacing?parseFloat(s.chartspacing):5):20+(s.chartspacing?parseFloat(s.chartspacing):5))+(s.chart2Height?parseFloat(s.chart2Height)+(s.chartspacing?parseFloat(s.chartspacing):5):40+(s.chartspacing?parseFloat(s.chartspacing):5))+"%",height:s.chart3Height?s.chart3Height+"%":"30%",offset:0,lineWidth:2,min:s.yAxis3min?parseFloat(s.yAxis3min):void 0,max:s.yAxis3max?parseFloat(s.yAxis3max):void 0,tickAmount:s.yAxis3tickamount?s.yAxis3tickamount:void 0,minorTicks:!0}),g=Highcharts.stockChart(i+c,{chart:{width:h.width()-2,height:h.height()-2,zoomType:"x",renderTo:i+c,panning:!0,panKey:"shift"},title:{text:s.title},time:{useUTC:!1},rangeSelector:{buttons:[{type:"day",count:1,text:"1 Tag",title:"1 Tag anzeigen"},{type:"day",count:3,text:"3 Tage",title:"3 Tage anzeigen"},{type:"day",count:7,text:"7 Tage",title:"7 Tage anzeigen"},{type:"month",count:1,text:"1M",title:"1 Monat anzeigen"},{type:"month",count:3,text:"3M",title:"3 Monate anzeigen"},{type:"month",count:6,text:"6M",title:"6 Monate anzeigen"}],allButtonsEnabled:!0,dropdown:"always",height:10,selected:{"1d":0,"3d":1,"7d":2,"1m":3,"3m":4,"6m":5}[s.zoomDefault],inputDateFormat:"%e. %b %Y"},navigator:{adaptToUpdatedData:!1,height:20,margin:10,series:[{data:null,dataGrouping:{enabled:!0,approximation:"high",units:u.highchartsSeriesUnits},pointInterval:1e4}],xAxis:{ordinal:!1}},scrollbar:{enabled:!1},xAxis:{events:{afterSetExtremes:function(e){console.log("afterSetExtremes event "+new Date(e.min)+" - "+new Date(e.max)+" - "+e.trigger),null!=e.trigger&&(r?(l=e,console.log("Save event "+new Date(e.min)+" - "+new Date(e.max)),n=!0):f(e.min,e.max))},setExtremes:function(e){console.log("setExtremes event "+new Date(e.min)+" - "+new Date(e.max)+" - "+e.trigger)}},ordinal:!1,dateTimeLabelFormats:u.highchartsDateTimeLabelFormats},yAxis:y,plotOptions:{},legend:{enabled:s.showLegend,align:"left",verticalAlign:"top",x:0,y:20,floating:!0,itemStyle:s.legendItemStyle?JSON.parse(s.legendItemStyle):{color:"#333333",cursor:"pointer",fontSize:"12px",fontWeight:"bold",textOverflow:"ellipsis"},itemDistance:s.legendItemDistance?parseInt(s.legendItemDistance):void 0},exporting:{enabled:s.showMenu},credits:{enabled:!1},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>',valueDecimals:2,split:!0,followTouchMove:!1,dateTimeLabelFormats:u.highchartsDateTimeLabelFormats},series:a}),window.setTimeout(function(){loadSelectorData(d,p.historyOID,p.instance,null,p.multiplicator,"no",s.navigatorRange?parseInt(s.navigatorRange):3,function(){g.navigator.series[0].setData(d),g.navigator.series[0].xAxis.min=d&&0<d.length?d[0][0]:void 0;var e=new Date;e.setUTCMilliseconds(0),e.setUTCSeconds(0),"1d"==s.zoomDefault?e.setDate(e.getDate()-1):"3d"==s.zoomDefault?e.setDate(e.getDate()-3):"7d"==s.zoomDefault?e.setDate(e.getDate()-7):"1m"==s.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-1)):"3m"==s.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-3)):"6m"==s.zoomDefault&&(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-6)),f(e.getTime(),(new Date).getTime(),function(){u.updateIntervalHandler[c]&&window.clearInterval(u.updateIntervalHandler[c]),u.reloadIntervalHandler[c]&&window.clearInterval(u.reloadIntervalHandler[c]);var n=0;$("#"+i+c).mousewheel(function(e,t){0<t?(n=-1*u.scrollspeed,a()):t<0&&(n=u.scrollspeed,a())});var a=function(){var e=g.xAxis[0].getExtremes().dataMin,t=g.xAxis[0].getExtremes().dataMax,a=minDate,i=(new Date).getTime();g.xAxis[0].setExtremes(Math.max(a,e-n*(t-e)),Math.min(i,t+n*(t-e)),!0,!0,{trigger:"zoom"})};console.log("V2 chart restart update interval"),u.updateIntervalHandler[c]=window.setInterval(function(){w()},3e4),console.log("V2 chart data.autoreload:"+s.autoreload),0<s.autoreload&&(u.updateIntervalHandler[c]=window.setInterval(function(){!function(){if(console.log("Start reload chart"),g){var t=g.xAxis[0].getExtremes();g.navigator.xAxis.max,loadSelectorData(d=[],p.historyOID,p.instance,null,p.multiplicator,"no",s.navigatorRange?parseInt(s.navigatorRange):3,function(){g.navigator.series[0].setData(d);var e=g.navigator.xAxis.max;g.xAxis[0].setExtremes(t.min+e-t.max,e,!0,!0,{trigger:"zoom"})})}else u.reloadIntervalHandler[c]&&(window.clearInterval(u.reloadIntervalHandler[c]),u.reloadIntervalHandler[c]=null)}()},6e4*s.autoreload))})})},10)},createTimeseries3Widget:function(r,e,l,t){var a=[],s=[],d="chart_placeholder",c=null,g=this,o=!1,i=!1,n=null;console.log(" photovoltaikcharts: Create Timeseries3 Widget");var u=$("#"+r);if(!u.length)return setTimeout(function(){g.createTimeseries3Widget(r,e,l,t)},100);console.log("Initialize Chart Widget #"+r);"undefined"!=typeof sysLang&&sysLang;var h=l.unit;s=[],a=[];var p,m,v=0;for(p=1;p<=l.seriesCount;p++)l["serieshistoryoid"+p]&&l["instance"+p]&&(m=l["serieslabel"+p],s.push({id:v,historyOID:l["serieshistoryoid"+p],instance:l["instance"+p],multiplicator:parseFloat(l["multiplicator"+p])||1,lastX:0}),a.push({name:m,data:[],color:l["seriescolor"+p]||"#FF5A33",lineWidth:l["serieslinewidth"+p]||1,fillOpacity:l["seriesopacity"+p]?parseFloat(l["seriesopacity"+p])/100:.3,type:l["seriesType"+p]||"areaspline",step:l["seriesstep"+p]&&"no"!=l["seriesstep"+p]?l["seriesstep"+p]:void 0,stacking:l["seriesstacking"+p]&&"no"!=l["seriesstacking"+p]?l["seriesstacking"+p]:void 0,dataGrouping:{enabled:l["seriesgrouping"+p],approximation:"high",units:"column"!=l["seriesType"+p]?g.highchartsSeriesUnits:void 0},states:{hover:{enabled:!0,lineWidth:l["serieshoverlinewidth"+p]||1}},pointInterval:1e4}),v++);function x(e,t,a){if(console.log("resize chart to "+new Date(e)+" - "+new Date(t)),!1,e&&t){o=!0;var i=e,n=t;c.showLoading(),window.setTimeout(function(){loadSeriesRange(c,s,0,l.normalizeDate,e,t,i,n,function(){c.redraw(),c.hideLoading(),o=!1,a&&a()})},10)}}l.target&&[].push({color:"#33FF50",dashStyle:"Solid",label:l.targetName||"Target",value:parseFloat(l.target),width:2}),g.delayedRefreshHandler[r]&&window.clearInterval(g.delayedRefreshHandler[r]),g.delayedRefreshHandler[r]=window.setInterval(function(){0==o&&1==i&&(i=!1,console.log("Process event "+new Date(n.min)+" - "+new Date(n.max)),x(n.min,n.max))},500),"de"===vis.language&&Highcharts.setOptions(g.highchartsOptions);vis.states[l.serieshistoryoid1];function f(){if(console.log("Start update chart"),c){var e,t,a,i=c.xAxis[0].getExtremes();0==o&&(new Date).getTime()-6e5<i.max&&(e=i.dataMax,t=(new Date).getTime(),a=function(e){c.xAxis[0].setExtremes(i.dataMin+e-i.dataMax,e),console.log("Updated chart data to "+new Date(i.dataMin+e-i.dataMax)+" - "+new Date(e))},console.log("load and add new Data for "+new Date(e)+" - "+new Date(t)),e&&t&&window.setTimeout(function(){loadAndAddSeriesRange(c,s,0,l.normalizeDate,e,t,e,function(e){a&&a(e)})},10))}else g.updateIntervalHandler[r]&&(window.clearInterval(g.updateIntervalHandler[r]),g.updateIntervalHandler[r]=null)}function y(e,t,a){if(console.log("Change zoom"),c&&t!=a&&l.zoomoid&&vis.states[l.zoomoid+".val"]){var i=c.xAxis[0].getExtremes(),n=new Date(new Date(i.dataMax).getTime()-1e3*t);c.xAxis[0].setExtremes(n.getTime(),i.dataMax,!0,!0,{trigger:"zoom"})}}c=new Highcharts.stockChart(d+r,{chart:{width:u.width()-2,height:u.height()-2,zoomType:"x",panning:!0,panKey:"shift",renderTo:d+r,backgroundColor:"rgba(255,255,255,0)",events:{click:function(){l.storeTimestampSelected&&(c.xAxis[0].removePlotLine("selected"),vis.setValue(l.storeTimestampSelected,this.hoverPoint.x),c.xAxis[0].addPlotLine({value:this.hoverPoint.x,color:"red",width:2,id:"selected"}))}}},title:{text:l.title},time:{useUTC:!1},rangeSelector:{enabled:!1,buttons:[{type:"day",count:1,text:"1 Tag",title:"1 Tag anzeigen"},{type:"day",count:3,text:"3 Tage",title:"3 Tage anzeigen"},{type:"day",count:7,text:"7 Tage",title:"7 Tage anzeigen"},{type:"month",count:1,text:"1M",title:"1 Monat anzeigen"},{type:"month",count:3,text:"3M",title:"3 Monate anzeigen"},{type:"month",count:6,text:"6M",title:"6 Monate anzeigen"}],allButtonsEnabled:!0,dropdown:"always",height:10,inputDateFormat:"%e. %b %Y"},navigator:{enabled:!1,series:[{data:null,dataGrouping:{enabled:!0,approximation:"high",units:g.highchartsSeriesUnits},pointInterval:1e4}],xAxis:{ordinal:!1}},scrollbar:{enabled:!1},xAxis:{events:{afterSetExtremes:function(e){console.log("afterSetExtremes event "+new Date(e.min)+" - "+new Date(e.max)+" - "+e.trigger),null!=e.trigger&&(o?(n=e,console.log("Save event "+new Date(e.min)+" - "+new Date(e.max)),i=!0):x(e.min,e.max))},setExtremes:function(e){console.log("setExtremes event "+new Date(e.min)+" - "+new Date(e.max)+" - "+e.trigger)}},ordinal:!1,dateTimeLabelFormats:g.highchartsDateTimeLabelFormats,crosshair:l.showCrosshairX},yAxis:[{labels:{formatter:function(){return this.value+(h?" "+h:"")},align:"left",x:1,crosshair:l.showCrosshairY},lineWidth:2,offset:0,categories:l.yAxis1Categories?JSON.parse(l.yAxis1Categories):void 0,min:l.yAxis1min?parseFloat(l.yAxis1min):void 0,max:l.yAxis1max?parseFloat(l.yAxis1max):void 0,tickAmount:l.yAxis1tickamount?l.yAxis1tickamount:void 0,minorTicks:!0,startOnTick:!1,visible:l.showYAxis}],plotOptions:{series:{events:{click:function(e){l.storeTimestampSelected&&(c.xAxis[0].removePlotLine("selected"),vis.setValue(l.storeTimestampSelected,e.point.x),c.xAxis[0].addPlotLine({value:e.point.x,color:"red",width:2,id:"selected"}))}}}},legend:{enabled:l.showLegend,align:"left",verticalAlign:"top",x:0,y:2,floating:!0},exporting:{enabled:l.showMenu},credits:{enabled:!1},tooltip:{pointFormat:'<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>',valueDecimals:2,split:!0,followTouchMove:!1,dateTimeLabelFormats:g.highchartsDateTimeLabelFormats},series:a}),$(window).resize(function(){console.log("Resize Chart "+d+r),c.setSize(null,null)}),window.setTimeout(function(){var e=new Date;e.setUTCMilliseconds(0),e.setUTCSeconds(0),l.zoomoid&&vis.states[l.zoomoid+".val"]?(console.log("use range info from zoomid:"+vis.states[l.zoomoid+".val"]+" type "+typeof vis.states[l.zoomoid+".val"]),e=new Date((new Date).getTime()-1e3*vis.states[l.zoomoid+".val"])):"1d"==l.zoomDefault?e.setDate(e.getDate()-1):"3d"==l.zoomDefault?e.setDate(e.getDate()-3):"7d"==l.zoomDefault?e.setDate(e.getDate()-7):"1m"==l.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-1)):"3m"==l.zoomDefault?(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-3)):"6m"==l.zoomDefault&&(e.setUTCMinutes(0),e.setUTCHours(0),e.setUTCMonth(e.getMonth()-6)),x(e.getTime(),(new Date).getTime(),function(){c.xAxis[0].allowZoomOutside=!0;var n=0;$("#"+d+r).mousewheel(function(e,t){0<t?(n=-1*g.scrollspeed,a()):t<0&&(n=g.scrollspeed,a())});var a=function(){var e=c.xAxis[0].getExtremes().dataMin,t=c.xAxis[0].getExtremes().dataMax,a=minDate,i=(new Date).getTime();c.xAxis[0].setExtremes(Math.max(a,e-n*(t-e)),Math.min(i,t+n*(t-e)),!0,!0,{trigger:"zoom"})};function i(){var e=o();e+parseInt(l.playstep||1)<c.series[0].points.length?e+=parseInt(l.playstep||1):e=0,c.xAxis[0].removePlotLine("selected"),vis.setValue(l.storeTimestampSelected,c.series[0].points[e].x),c.xAxis[0].addPlotLine({value:c.series[0].points[e].x,color:"red",width:2,id:"selected"}),g.playHandler[r]&&window.clearInterval(g.playHandler[r]),1==vis.states[l.playid+".val"]&&(g.playHandler[r]=window.setTimeout(function(){i()},1e3*parseInt(l.playspeed||3)))}function e(e,t,a){1==t&&(vis.setValue(l.stepforwardid,!1),i())}function t(e,t,a){var i;1==t&&(vis.setValue(l.stepbackid,!1),(i=o())>parseInt(l.playstep||1)?i-=parseInt(l.playstep||1):i=c.series[0].points.length-parseInt(l.playstep||1),c.xAxis[0].removePlotLine("selected"),vis.setValue(l.storeTimestampSelected,c.series[0].points[i].x),c.xAxis[0].addPlotLine({value:c.series[0].points[i].x,color:"red",width:2,id:"selected"}))}function s(e,t,a){1==t&&i()}function o(){var e,t;if(0<c.xAxis[0].plotLinesAndBands.length){for(t=0;t<c.xAxis[0].plotLinesAndBands.length;t++)if("selected"==c.xAxis[0].plotLinesAndBands[t].id){e=c.xAxis[0].plotLinesAndBands[t].options.value;break}if(!e)return 0;for(t=0;t<c.series[0].points.length;t++)if(c.series[0].points[t].x==e)return t}return 0}l.storeTimestampSelected&&c.series&&c.series[0]&&0<c.series[0].points.length&&(vis.setValue(l.storeTimestampSelected,c.series[0].points[c.series[0].points.length-1].x),c.xAxis[0].addPlotLine({value:c.series[0].points[c.series[0].points.length-1].x,color:"red",width:2,id:"selected"})),g.updateIntervalHandler[r]&&window.clearInterval(g.updateIntervalHandler[r]),g.updateIntervalHandler[r]=window.setInterval(function(){f()},3e4),l.playid&&l.storeTimestampSelected&&(console.log("register on changes for "+l.playid),vis.states.bind(l.playid+".val",s),u.data("bound",[l.playid+".val"]),u.data("bindHandler",s)),l.stepbackid&&l.storeTimestampSelected&&(console.log("register on changes for "+l.stepbackid),vis.states.bind(l.stepbackid+".val",t),u.data("bound",[l.stepbackid+".val"]),u.data("bindHandler",t)),l.stepbackid&&l.storeTimestampSelected&&(console.log("register on changes for "+l.stepforwardid),vis.states.bind(l.stepforwardid+".val",e),u.data("bound",[l.stepforwardid+".val"]),u.data("bindHandler",e)),1!=vis.editMode&&l.storeTimestampSelected&&1==vis.states[l.playid+".val"]&&(g.playHandler[r]=window.setTimeout(function(){i()},1e3*parseInt(l.playspeed||3))),c.setSize(null,null)})},10),l.zoomoid&&(console.log("register on changes for "+l.zoomoid),vis.states.bind(l.zoomoid+".val",y),u.data("bound",[l.zoomoid+".val"]),u.data("bindHandler",y))},createPhotovoltaikModuleWidget:function(i,e,n,t){var a=this,r=[],l=!1,s=$("#"+i);if(!s.length)return setTimeout(function(){a.createPhotovoltaikModuleWidget(i,e,n,t)},100);function o(e,t,s,a,o){var i={};if(l)return o();l=!0,i.start=a-1,i.end=a+72e4,i.instance=t,i.aggregate="none",i.count=1,i.timeout=5e3,vis.getHistory(e,i,function(e,t){if(l=!1,e&&0<Object.keys(e).length&&(console.error("Error Object: "+e),o()),!e&&t){if(0<t.length){for(var a=(new Date).getTime(),i=0;i<t.length;i++){var n={val:t[i].val,cacheDate:a};r[t[i].ts]=n}o((t[0].val||0)*s)}t=null}})}function d(e){var t=e/(n.modulePower||355);return.9<t?"#F4FD02":.8<t?"#12FD02":.6<t?"#02FDAD":.4<t?"#02D4FD":.2<t?"#029BFD":.1<t?"#0208FD":"#0238FD"}var c=$("#photovoltaikmodule"+i).find("svg:first");function g(e,t,a){console.log("Changed value for widget "+i+" value "+new Date(t)),null!=e&&t!=a&&(null!=r[t]&&r[t].cacheDate>(new Date).getTime()-36e4?r[t].val?($("#power",c).text(r[t].val.toLocaleString(void 0,{minimumFractionDigits:2})),$("#modulecolor",c).attr("fill",d(r[t].val))):0===r[t].val&&($("#power",c).text("--"),$("#modulecolor",c).attr("fill","#007fff")):window.setTimeout(function(){o(n.serieshistoryoid,n.instance,parseFloat(n.multiplicator||1),t,function(e){e?($("#power",c).text(e.toLocaleString(void 0,{minimumFractionDigits:2})),$("#modulecolor",c).attr("fill",d(e))):0===e&&($("#power",c).text("--"),$("#modulecolor",c).attr("fill","#007fff"))})},10))}$("#label",c).text(n.serieslabel),n.serieshistoryoid&&n.instance&&n.timestampid&&vis.states[n.timestampid+".val"]?o(n.serieshistoryoid,n.instance,parseFloat(n.multiplicator||1),vis.states[n.timestampid+".val"],function(e){e?($("#power",c).text(e.toLocaleString(void 0,{minimumFractionDigits:2})),$("#modulecolor",c).attr("fill",d(e))):($("#power",c).text("--"),$("#modulecolor",c).attr("fill","#007fff"))}):($("#power",c).text("--"),$("#modulecolor",c).attr("fill","#007fff")),n.timestampid&&(console.log("register on changes for "+n.timestampid),vis.states.bind(n.timestampid+".val",g),s.data("bound",[n.timestampid+".val"]),s.data("bindHandler",g))},createGaugeWidget:function(e,t,i,a){var n=null,s=this;console.log(" vis-photovoltaikcharts: Create Gauge Widget");var o=$("#"+e);if(!o.length)return setTimeout(function(){s.createGaugeWidget(e,t,i,a)},100);console.log("Initialize Chart Widget #"+e);"undefined"!=typeof sysLang&&sysLang;var r={chart:{type:"solidgauge"},title:void 0,pane:{center:[i.panCenterX?i.panCenterX+"%":"50%",i.panCenterY?i.panCenterY+"%":"50%"],size:"160%",startAngle:i.startAngel?parseInt(i.startAngel):-90,endAngle:i.stopAngel?parseInt(i.stopAngel):90,background:{backgroundColor:{linearGradient:{x1:0,y1:0,x2:0,y2:1},stops:[[0,i.paneBackgroundColor1||"#ffffff"],[1,i.paneBackgroundColor2||"#eee"]]},borderColor:i.borderColor,innerRadius:i.innerRadius?i.innerRadius+"%":"60%",outerRadius:i.outerRadius?i.outerRadius+"%":"100%",shape:i.shape||"arc"}},exporting:{enabled:!1},tooltip:{enabled:!1},yAxis:{stops:[],lineWidth:i.lineWidth,tickWidth:i.tickWidth,minorTickInterval:parseInt(i.minorTickInterval),tickAmount:parseInt(i.tickAmount),title:{y:parseInt(i.titlePositionY)||-70},labels:{y:parseInt(i.labelsPositionY)||16},min:parseInt(i.min)||0,max:parseInt(i.max)||100,title:{text:i.title}},plotOptions:{solidgauge:{dataLabels:{y:parseInt(i.dataLabelsPositionY)||5,borderWidth:parseInt(i.dataLabelsBorderWidth)||0,useHTML:!0}}},credits:{enabled:!1},series:[{name:i.title,data:[vis.states[i.oid+".val"]*(parseFloat(i.multiplicator)||1)],dataLabels:{format:'<div style="text-align:center"><span style="font-size:'+(i.fontsizevalue||"25px")+'">{y}</span><br/>'+(i.valuesuffix?'<span style="font-size:'+(i.fontsizesuffix||"12px")+';opacity:0.4">'+i.valuesuffix+"</span>":"")+"</div>"},tooltip:{valueSuffix:i.valuesuffix}}]};if(0<i.stopCount)for(var l,d=0;d<i.stopCount;d++)i["stopposition"+(d+1)]&&(l=[i["stopposition"+(d+1)]/100,i["stopcolor"+(d+1)]],r.yAxis.stops.push(l));n=Highcharts.chart("chart_placeholder"+e,r);function c(e,t,a){n&&t!=a&&n.series[0].points[0].update(t*(parseFloat(i.multiplicator)||1))}null!=i.oid&&(console.log("register on changes for "+i.oid),vis.states.bind(i.oid+".val",c),o.data("bound",[i.oid+".val"]),o.data("bindHandler",c))}},vis.binds.photovoltaikcharts.showVersion();
//# sourceMappingURL=photovoltaikCharts.js.map
